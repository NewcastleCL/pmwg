<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to pmwg • pmwg</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to pmwg">
<meta property="og:description" content="A getting started guide for working with pmwg
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pmwg</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/pmwg.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../FAQ.html">FAQ</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Releases</li>
    <li>
      <a href="https://newcastlecl.github.io/2021/02/10/PMWG-version-0.2.0-released.html">pmwg 0.2.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/newcastlecl/pmwg/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to pmwg</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/newcastlecl/pmwg/blob/master/vignettes/pmwg.Rmd"><code>vignettes/pmwg.Rmd</code></a></small>
      <div class="hidden name"><code>pmwg.Rmd</code></div>

    </div>

    
    
<p>pmwg is a package that implements an efficient and flexible Particle Metropolis within Gibbs sampler as outlined in the paper <span class="citation">(Gunawan et al. 2020)</span>. The sampler estimates group level parameter values, the covariance matrix related parameter estimates to each other and the individual level parameter estimates (random effects) in a two step process. The process consists of a Gibbs sampling step for group level/covariate estimates followed by a particle metropolis step for random effects for each iteration of the sampler.</p>
<p>The sampling proceeds through three stages, burn in, adaptation and a final sampling stage. Burn in can be relatively short and should move the sample estimates from the start values to a plausible region of the parameter space relatively quickly. The adaptation stage is the same as burn in, however samples from this stage are used to generate a proposal distribution used to create samples more efficiently for the final sampling stage.</p>
<div id="the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#the-data" class="anchor"></a>The data</h2>
<p>First we will load the pmwg package and explore the included dataset</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/newcastlecl/pmwg">pmwg</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">forstmann</span><span class="op">)</span></code></pre></div>
<pre><code>##      subject condition stim resp     rt
## 1115       1         1    2    2 0.4319
## 1116       1         3    2    2 0.5015
## 1117       1         3    1    1 0.3104
## 1118       1         1    2    2 0.4809
## 1119       1         1    1    1 0.3415
## 1120       1         2    1    1 0.3465</code></pre>
<p>The forstmann dataset is from <span class="citation">(Forstmann et al. 2008)</span> and is the cleaned data from an experiment that displayed a random dot motion task with one of three speed accuracy manipulations (respond accurately instructions, neutral instructions and respond quickly instructions).</p>
<p>We can see that there are 5 columns:</p>
<ul>
<li>
<code>subject</code> - which gives an ID for each of the 19 participants</li>
<li>
<code>condition</code> - the speed accuracy instructions for the trial</li>
<li>
<code>stim</code> - whether dots were moving left or right</li>
<li>
<code>resp</code> - whether the participant responded left or right</li>
<li>
<code>rt</code> - the response time for the trial</li>
</ul>
<p>We will use the <code>rtdists</code> package to look at threshold differences between the three conditions to see whether there is evidence for different thresholds (the evidence required to trigger a response) in each of the three conditions. For a full explanation of the model please see the <a href="https://newcastlecl.github.io/samplerDoc/">full documentation</a> in Chapter 3.</p>
</div>
<div id="the-log-likelihood-function" class="section level2">
<h2 class="hasAnchor">
<a href="#the-log-likelihood-function" class="anchor"></a>The log-likelihood function</h2>
<p>Now that we have the data we will need to specify the log-likelihood function.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lba_loglike</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">rt</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="st">"t0"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1e10</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># This is faster than "paste".</span>
  <span class="va">bs</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"b1"</span>, <span class="st">"b2"</span>, <span class="st">"b3"</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">condition</span><span class="op">]</span>

  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">rtdists</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rtdists/man/LBA.html">dLBA</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">rt</span>, <span class="co"># nolint</span>
    response <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">stim</span>,
    A <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span>,
    b <span class="op">=</span> <span class="va">bs</span>,
    t0 <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="st">"t0"</span><span class="op">]</span>,
    mean_v <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"v1"</span>, <span class="st">"v2"</span><span class="op">)</span><span class="op">]</span>,
    sd_v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
    distribution <span class="op">=</span> <span class="st">"norm"</span>,
    silent <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>
  <span class="va">bad</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">out</span> <span class="op">&lt;</span> <span class="fl">1e-10</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span>
  <span class="va">out</span><span class="op">[</span><span class="va">bad</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1e-10</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span>
  <span class="va">out</span>
<span class="op">}</span></code></pre></div>
<p>This function contains the primary implementation of our model for the data. The <code>pmwgs</code> object that we run later in this example will pass two things:</p>
<ul>
<li>A set of parameter values <code>x</code> that we will be assessing.</li>
<li>A subset of our dataset (<code>data</code>), the data for one subject.</li>
</ul>
<p>Our job then in the function is to take the parameter values and calculate the log-likelihood of the data given the parameter values.</p>
<p>The overall process is as follows:</p>
<ul>
<li>Take the exponent of the parameter values (that are stored in log-form</li>
<li>Test for improbable values of t0 (non-decision time) and return extremely low log-likelihood if they are unlikely.</li>
<li>Create a vector of b (threshold) parameter values for the call to rtdists</li>
<li>Use the rtdists <code>dLBA</code> function to calculate the likelihood of the data given our parameter estimates.</li>
<li>Clean extremely small of otherwise bad values from output vector.</li>
<li>Return the sum of the log of the likelihood of each row of the data.</li>
</ul>
</div>
<div id="other-necessary-components" class="section level2">
<h2 class="hasAnchor">
<a href="#other-necessary-components" class="anchor"></a>Other necessary components</h2>
<p>There are a couple of other necessary components to running the sampler, a list of parameters and a prior for the group level parameter values.</p>
<p>In this case the parameters consist of threshold parameters for each of the three conditions (<code>b1</code>, <code>b2</code> and <code>b3</code>), a upper limit on the range for accumulator start points (<code>A</code>), the drift rates for evidence accumulation for the two stimulus types (<code>v1</code> and <code>v2</code>) and non-decision time (<code>t0</code>).</p>
<p>The prior for this model is uninformed and is just 0 for the mean of the group parameters and standard deviation of 1 for each parameter.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"b1"</span>, <span class="st">"b2"</span>, <span class="st">"b3"</span>, <span class="st">"A"</span>, <span class="st">"v1"</span>, <span class="st">"v2"</span>, <span class="st">"t0"</span><span class="op">)</span>

<span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  theta_mu_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span>,
  theta_mu_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="creating-and-running-the-sampler" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-and-running-the-sampler" class="anchor"></a>Creating and running the sampler</h2>
<p>Once we have these components we are ready to create and run the sampler.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create the Particle Metropolis within Gibbs sampler object</span>
<span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmwgs.html">pmwgs</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">forstmann</span>,
  pars <span class="op">=</span> <span class="va">pars</span>,
  ll_func <span class="op">=</span> <span class="va">lba_loglike</span>,
  prior <span class="op">=</span> <span class="va">priors</span>
<span class="op">)</span></code></pre></div>
<p>Creation of the sampler object is done through a call to the <code>pmwgs</code> function, which creates the object and sets numerous precomputed values based on the number of parameters and other aspects of the included function arguments. Next steps are to initialise the sampler with start values for the random effects and then run the three stages of sampling.</p>
<p>The stages can be long running, but once complete you will have</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Initialise (generate first random effects for sampler)</span>
<span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init.html">init</a></span><span class="op">(</span><span class="va">sampler</span><span class="op">)</span>  <span class="co"># Can also pass start points for sampler</span>

<span class="co"># Run each stage of the sampler, can adjust number of particles on each</span>
<span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_stage.html">run_stage</a></span><span class="op">(</span><span class="va">sampler</span>, stage<span class="op">=</span><span class="st">"burn"</span><span class="op">)</span>
<span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_stage.html">run_stage</a></span><span class="op">(</span><span class="va">sampler</span>, stage<span class="op">=</span><span class="st">"adapt"</span><span class="op">)</span>
<span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_stage.html">run_stage</a></span><span class="op">(</span><span class="va">sampler</span>, stage<span class="op">=</span><span class="st">"sample"</span><span class="op">)</span></code></pre></div>
<p>The <code>run_stage</code> command can also be passed other arguments such as <code>iter</code> for number of iterations, <code>particles</code> for number of particles among others and more. For a full list see <a href="https://newcastlecl.github.io/samplerDoc/pmwg-sampler-and-signal-detection-theory.html#run-sdtsampler">the description in the PMwG Tutorial Book</a>.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-forstmann2008">
<p>Forstmann, Birte U., Gilles Dutilh, Scott Brown, Jane Neumann, D. Yves von Cramon, K. Richard Ridderinkhof, and Eric-Jan Wagenmakers. 2008. “Striatum and Pre-Sma Facilitate Decision-Making Under Time Pressure.” <em>Proceedings of the National Academy of Sciences</em> 105 (45). National Academy of Sciences: 17538–42. doi:<a href="https://doi.org/10.1073/pnas.0805903105">10.1073/pnas.0805903105</a>.</p>
</div>
<div id="ref-gunawan2020">
<p>Gunawan, D., G.E. Hawkins, M.-N. Tran, R. Kohn, and S.D. Brown. 2020. “New Estimation Approaches for the Hierarchical Linear Ballistic Accumulator Model.” <em>Journal of Mathematical Psychology</em> 96: 102368. doi:<a href="https://doi.org/https://doi.org/10.1016/j.jmp.2020.102368">https://doi.org/10.1016/j.jmp.2020.102368</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Gavin Cooper, Reilly Innes, Caroline Kuhne, Jon-Paul Cavallaro, David Gunawan, Guy Hawkins, Scott Brown.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
